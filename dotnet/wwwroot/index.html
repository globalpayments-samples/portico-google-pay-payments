<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Payments - Developer Example</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://globalpayments-samples.github.io/css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="gp-header">
        <div class="gp-container">
            <div class="gp-header-content">
                <div class="gp-logo">
                    <picture>
                        <source media="(min-width: 768px)" srcset="https://globalpayments-samples.github.io/assets/img/GP_logo.svg">
                        <img src="https://globalpayments-samples.github.io/assets/img/GP_favicon.svg" alt="Global Payments" style="height: 32px; width: auto;">
                    </picture>
                </div>
                <nav class="gp-header-nav">
                    <a href="https://developer.globalpay.com/">Documentation</a>
                    <a href="https://developer.globalpay.com/api">API Reference</a>
                    <a href="https://developer.globalpay.com/sdks">SDKs</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="gp-container">
        <!-- Page Title -->
        <h1 class="gp-page-title">SDK Integration Examples</h1>
        <p class="gp-page-subtitle">Explore comprehensive examples of Global Payments SDK implementations across different payment scenarios.</p>

        <!-- Tabs -->
        <div class="gp-tabs">
            <div class="gp-tab-list">
                <button class="gp-tab-button active" data-tab="google-pay">Google Pay</button>
            </div>

            <!-- Google Pay Tab -->
            <div class="gp-tab-content active" id="google-pay">
                <div class="gp-card">
                    <div class="gp-card-header">
                        <h2 class="gp-card-title">Google Pay Integration</h2>
                        <p class="gp-card-description">
                            Secure payments using Google Pay with Portico Gateway processing.
                        </p>
                    </div>
                    
                    <form id="google-pay-form" class="gp-form">
                        <div class="gp-form-group">
                            <label for="google-pay-amount" class="gp-label">Amount ($):</label>
                            <input type="number" id="google-pay-amount" name="amount" class="gp-input" min="0.01" step="0.01" value="10.00" required>
                        </div>
                        
                        <div class="gp-form-group">
                            <label for="google-pay-billing-zip" class="gp-label">Billing Zip Code (Optional):</label>
                            <input type="text" id="google-pay-billing-zip" name="billing_zip" class="gp-input" placeholder="12345">
                        </div>

                        <div class="gp-form-group">
                            <label class="gp-label">Payment Method:</label>
                            <div id="google-pay-button-container" style="margin: 16px 0;">
                                <!-- Google Pay button will be inserted here -->
                            </div>
                        </div>
                    </form>

                    <div id="google-pay-result" class="gp-hidden">
                        <h3 class="gp-card-title gp-mt-lg">Transaction Result:</h3>

                        <h3>Token:</h3>
                        <div id="token" name="token"></div>

                        <div id="paymentReference"></div>

                        <div class="gp-code-block" id="google-pay-result-display"></div>
                    </div>

                    <div class="gp-alert gp-alert-info">
                        <strong>Note:</strong> This example uses the Google Pay TEST environment. Real payment methods won't be charged.
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <!-- 
        DEVELOPER NOTE: Update the following footer information to match your business:
        - Company name and copyright year
        - Update all links to point to your actual Terms of Service, Privacy Policy, and Refund Policy pages
        - Refund Policy link is typically required by payment processor underwriting in addition to Terms and Privacy
        - Ensure all linked policies are accessible and up-to-date before going live
    -->
    <footer class="gp-footer">
        <div class="gp-container">
            <div class="gp-footer-content">
                <div class="gp-footer-section">
                    <p class="gp-footer-copyright">
                        Â© 2024 Your Company Name. All rights reserved.
                    </p>
                </div>
                <div class="gp-footer-section">
                    <nav class="gp-footer-nav">
                        <a href="/terms-of-service" class="gp-footer-link">Terms of Service</a>
                        <a href="/privacy-policy" class="gp-footer-link">Privacy Policy</a>
                        <a href="/refund-policy" class="gp-footer-link">Refund Policy</a>
                    </nav>
                </div>
            </div>
        </div>
    </footer>

    <script async src="https://pay.google.com/gp/p/js/pay.js"></script>
    <script src="https://globalpayments-samples.github.io/js/script.js"></script>
    <script>
        let merchantName = 'Test Merchant';
        let googlePayMerchantId = undefined;

        /**
         * Define the version of the Google Pay API referenced when creating your
         * configuration
         *
         * @see {@link https://developers.google.com/pay/api/web/reference/request-objects#PaymentDataRequest|apiVersion in PaymentDataRequest}
         */
        const baseRequest = {
            apiVersion: 2,
            apiVersionMinor: 0,
        };

        /**
         * Card networks supported by your site and your gateway
         *
         * @see {@link https://developers.google.com/pay/api/web/reference/request-objects#CardParameters|CardParameters}
         * @todo confirm card networks supported by your site and gateway
         */
        const allowedCardNetworks = [
            "AMEX",
            "DISCOVER",
            "INTERAC",
            "JCB",
            "MASTERCARD",
            "VISA",
        ];

        /**
         * Card authentication methods supported by your site and your gateway
         *
         * @see {@link https://developers.google.com/pay/api/web/reference/request-objects#CardParameters|CardParameters}
         * @todo confirm your processor supports Android device tokens for your
         * supported card networks
         */
        const allowedCardAuthMethods = ["PAN_ONLY", "CRYPTOGRAM_3DS"];

        /**
         * Identify your gateway and your site's gateway merchant identifier
         *
         * The Google Pay API response will return an encrypted payment method capable
         * of being charged by a supported gateway after payer authorization
         *
         * @todo check with your gateway on the parameters to pass
         * @see {@link https://developers.google.com/pay/api/web/reference/request-objects#gateway|PaymentMethodTokenizationSpecification}
         */
        const tokenizationSpecification = {
            type: "PAYMENT_GATEWAY",
            parameters: {
                gateway: "globalpayments",
                gatewayMerchantId: "",
            },
        };

        /**
         * Describe your site's support for the CARD payment method and its required
         * fields
         *
         * @see {@link https://developers.google.com/pay/api/web/reference/request-objects#CardParameters|CardParameters}
         */
        const baseCardPaymentMethod = {
            type: "CARD",
            parameters: {
                allowedAuthMethods: allowedCardAuthMethods,
                allowedCardNetworks: allowedCardNetworks,
            },
        };

        /**
         * Describe your site's support for the CARD payment method including optional
         * fields
         *
         * @see {@link https://developers.google.com/pay/api/web/reference/request-objects#CardParameters|CardParameters}
         */
        const cardPaymentMethod = Object.assign({}, baseCardPaymentMethod, {
            tokenizationSpecification: tokenizationSpecification,
        });

        /**
         * An initialized google.payments.api.PaymentsClient object or null if not yet set
         *
         * @see {@link getGooglePaymentsClient}
         */
        let paymentsClient = null;

        /**
         * Configure your site's support for payment methods supported by the Google Pay
         * API.
         *
         * Each member of allowedPaymentMethods should contain only the required fields,
         * allowing reuse of this base request when determining a viewer's ability
         * to pay and later requesting a supported payment method
         *
         * @returns {object} Google Pay API version, payment methods supported by the site
         */
        function getGoogleIsReadyToPayRequest() {
            return Object.assign({}, baseRequest, {
                allowedPaymentMethods: [baseCardPaymentMethod],
            });
        }

        /**
         * Configure support for the Google Pay API
         *
         * @see {@link https://developers.google.com/pay/api/web/reference/request-objects#PaymentDataRequest|PaymentDataRequest}
         * @returns {object} PaymentDataRequest fields
         */
        function getGooglePaymentDataRequest() {
            const paymentDataRequest = Object.assign({}, baseRequest);
            paymentDataRequest.allowedPaymentMethods = [cardPaymentMethod];
            paymentDataRequest.transactionInfo = getGoogleTransactionInfo();
            paymentDataRequest.merchantInfo = {
                merchantName: merchantName,
            };

            if (googlePayMerchantId) {
                // @todo a merchant ID is available for a production environment after approval by Google
                // See {@link https://developers.google.com/pay/api/web/guides/test-and-deploy/integration-checklist|Integration checklist}
                paymentDataRequest.merchantInfo.merchantId = googlePayMerchantId;
            }

            return paymentDataRequest;
        }

        /**
         * Return an active PaymentsClient or initialize
         *
         * @see {@link https://developers.google.com/pay/api/web/reference/client#PaymentsClient|PaymentsClient constructor}
         * @returns {google.payments.api.PaymentsClient} Google Pay API client
         */
        function getGooglePaymentsClient() {
            if (paymentsClient === null) {
                paymentsClient = new google.payments.api.PaymentsClient({
                    environment: "TEST",
                });
            }
            return paymentsClient;
        }

        /**
         * Initialize Google PaymentsClient after Google-hosted JavaScript has loaded
         *
         * Display a Google Pay payment button after confirmation of the viewer's
         * ability to pay.
         */
        function initializeGooglePay() {
            const paymentsClient = getGooglePaymentsClient();
            paymentsClient
                .isReadyToPay(getGoogleIsReadyToPayRequest())
                .then(function (response) {
                    if (response.result) {
                        addGooglePayButton();
                        // @todo prefetch payment data to improve performance after confirming site functionality
                        // prefetchGooglePaymentData();
                    }
                })
                .catch(function (err) {
                    // show error in developer console for debugging
                    console.error(err);
                });
        }

        /**
         * Add a Google Pay purchase button alongside an existing checkout button
         *
         * @see {@link https://developers.google.com/pay/api/web/reference/request-objects#ButtonOptions|Button options}
         * @see {@link https://developers.google.com/pay/api/web/guides/brand-guidelines|Google Pay brand guidelines}
         */
        function addGooglePayButton() {
            const paymentsClient = getGooglePaymentsClient();
            const button = paymentsClient.createButton({
                onClick: onGooglePaymentButtonClicked,
            });
            document.getElementById("google-pay-button-container").appendChild(button);
        }

        /**
         * Provide Google Pay API with a payment amount, currency, and amount status
         *
         * @see {@link https://developers.google.com/pay/api/web/reference/request-objects#TransactionInfo|TransactionInfo}
         * @returns {object} transaction info, suitable for use as transactionInfo property of PaymentDataRequest
         */
        function getGoogleTransactionInfo() {
            return {
                countryCode: "US",
                currencyCode: "USD",
                totalPriceStatus: "FINAL",
                // set to cart total
                totalPrice: document.getElementById('google-pay-amount').value,
            };
        }

        /**
         * Prefetch payment data to improve performance
         *
         * @see {@link https://developers.google.com/pay/api/web/reference/client#prefetchPaymentData|prefetchPaymentData()}
         */
        function prefetchGooglePaymentData() {
            const paymentDataRequest = getGooglePaymentDataRequest();
            // transactionInfo must be set but does not affect cache
            paymentDataRequest.transactionInfo = {
                totalPriceStatus: "NOT_CURRENTLY_KNOWN",
                currencyCode: "USD",
            };
            const paymentsClient = getGooglePaymentsClient();
            paymentsClient.prefetchPaymentData(paymentDataRequest);
        }

        /**
         * Show Google Pay payment sheet when Google Pay payment button is clicked
         */
        function onGooglePaymentButtonClicked() {
            // debugger;
            const paymentDataRequest = getGooglePaymentDataRequest();
            paymentDataRequest.transactionInfo = getGoogleTransactionInfo();

            const paymentsClient = getGooglePaymentsClient();
            paymentsClient
                .loadPaymentData(paymentDataRequest)
                .then(function (paymentData) {
                    // handle the response
                    processPayment(paymentData);
                })
                .catch(function (err) {
                    // show error in developer console for debugging
                    console.error(err);
                });
        }

        // Process the payment on the server
        function processPayment(paymentData) {
            paymentToken = paymentData.paymentMethodData.tokenizationData.token;

            const div = document.getElementById("paymentReference");
            const newParagraph = document.createElement("p"); 
            newParagraph.textContent = "Processing..";

            div.appendChild(newParagraph);

            const divToken = document.getElementById("token");

            const token = document.createElement("p"); 
            token.textContent = paymentToken;
            divToken.appendChild(token);

            // show returned data in developer console for debugging
            console.log(paymentData);

            const amount = document.getElementById('google-pay-amount').value;
            const billingZip = document.getElementById('google-pay-billing-zip').value;
            
            const requestData = {
                token: paymentToken,
                amount: amount,
                billing_zip: billingZip
            };

            fetch('/process-google-pay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("google-pay-result-display").textContent = JSON.stringify(data, undefined, 2);
                document.getElementById("paymentReference").textContent ='';

                if (data.success) {
                    showResult(data);
                } else {
                    showError(data.message || 'Payment processing failed');
                }
            })
            .catch(error => {
                console.error('Payment processing error:', error);
                showError('Network error: Unable to process payment');
            });
        }

        // Show payment result
        function showResult(data) {
            const resultDiv = document.getElementById('google-pay-result');
            const displayDiv = document.getElementById('google-pay-result-display');
            
            displayDiv.innerHTML = `
                <strong>Success!</strong><br>
                Transaction ID: ${data.data.transactionId}<br>
                Amount: $${data.data.amount}
            `;
            
            resultDiv.classList.remove('gp-hidden');
        }

        // Show error message
        function showError(message) {
            const resultDiv = document.getElementById('google-pay-result');
            const displayDiv = document.getElementById('google-pay-result-display');
            
            displayDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            resultDiv.classList.remove('gp-hidden');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load merchant configuration from server
            fetch('/config')
                .then(response => response.json())
                .then(config => {
                    if (config.data.merchantInfo) {
                        if (config.data.merchantInfo.merchantId) {
                            tokenizationSpecification.parameters.gatewayMerchantId = 
                                config.data.merchantInfo.merchantId;
                        }
                        if (config.data.merchantInfo.merchantName) {
                            merchantName = 
                                config.data.merchantInfo.merchantName;
                        }
                    }

                    if (config.data.googlePayConfig) {
                        if (config.data.googlePayConfig.googleMerchantId) {
                            googlePayMerchantId = config.data.googlePayConfig.googleMerchantId;
                        }
                    }

                    initializeGooglePay();
                })
                .catch(error => {
                    console.error('Failed to load configuration:', error);
                    initializeGooglePay(); // Initialize with defaults
                });
        });
    </script>
</body>
</html>